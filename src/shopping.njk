---
layout: layouts/base.njk
title: Shopping
permalink: /shopping/
---
<section class="card">
  <h2 class="text-xl font-semibold">Create Shopping List</h2>
  <div class="mt-4 grid gap-6 lg:grid-cols-2">
    <div>
      <div class="flex items-center gap-2 flex-wrap">
        <input id="search" placeholder="Search items‚Ä¶" class="mt-1 block w-full sm:flex-1 rounded-lg border-gray-300 focus:border-brand-500 focus:ring-brand-500 min-w-[220px]" />
        <label class="text-sm flex items-center gap-2"><input type="checkbox" id="favFilter"> Favorites</label>
        <label class="text-sm flex items-center gap-2">Sort
          <select id="sortBy" class="rounded-md border-gray-300 text-sm">
            <option value="default">Default</option>
            <option value="last_desc">Last bought (newest)</option>
            <option value="last_asc">Last bought (oldest)</option>
          </select>
        </label>
        <button class="btn-secondary" id="addAll">Add All Visible</button>
        <button class="btn" id="saveBtn">Save List</button>
      </div>
      <p class="muted mt-2 text-sm">Pick from curated categories below. Click + to add to the current list.</p>
      <div id="catalog" class="mt-4 space-y-3 max-h-[60vh] overflow-auto pr-1"></div>
    </div>
    <div>
  <label class="block text-sm font-medium">Title</label>
  <input id="title" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-brand-500 focus:ring-brand-500" placeholder="Shopping List" />
  <label class="block text-sm font-medium mt-3">Description</label>
  <textarea id="description" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 focus:border-brand-500 focus:ring-brand-500" placeholder="Short description (optional)"></textarea>
      <div class="mt-4 card">
        <h3 class="text-lg font-semibold">Markdown Preview</h3>
        <pre id="md" class="mt-3 whitespace-pre-wrap text-sm"></pre>
      </div>
      <div class="mt-2 flex items-center gap-2">
        <button class="btn-secondary" id="micBtn">üéôÔ∏è Speak items</button>
        <span id="micStatus" class="muted text-sm"></span>
      </div>
      <div class="mt-2 flex items-center gap-2 flex-wrap">
        <button class="btn" id="copyBtn">Copy Markdown</button>
  <a class="btn-secondary" id="viewLatest" href="#">View Saved List</a>
  <a class="btn-secondary hidden" id="shareLink" href="#" target="_blank">Open Share Link</a>
        <label class="text-sm flex items-center gap-2"><input type="checkbox" id="setBought"> Set last bought on save</label>
        <button class="btn-secondary" id="resetFavs">Reset Favorites</button>
        <button class="btn-secondary" id="resetDates">Reset Dates</button>
      </div>
    </div>
  </div>
</section>

<section class="card mt-6">
  <h3 class="text-lg font-semibold">Recent Lists</h3>
  <div id="lists" class="mt-3"></div>
</section>

<script>
(async function(){
  const catalogData = {{ shopping | dump | safe }};
  const catalogEl = document.getElementById('catalog');
  const mdEl = document.getElementById('md');
  const titleEl = document.getElementById('title');
  const saveBtn = document.getElementById('saveBtn');
  const copyBtn = document.getElementById('copyBtn');
  const viewLatest = document.getElementById('viewLatest');
  const listsEl = document.getElementById('lists');
  const descEl = document.getElementById('description');
  const shareLink = document.getElementById('shareLink');
  const searchEl = document.getElementById('search');
  const favFilterEl = document.getElementById('favFilter');
  const sortByEl = document.getElementById('sortBy');
  const addAllBtn = document.getElementById('addAll');
  const setBoughtEl = document.getElementById('setBought');
  const resetFavsBtn = document.getElementById('resetFavs');
  const resetDatesBtn = document.getElementById('resetDates');
  let chosen = [];
  let meta = {};

  function flattenCatalog(filterText){
    const out = [];
    const ft = (filterText||'').toLowerCase();
    if (!catalogData || typeof catalogData !== 'object') {
      console.error('Shopping catalog missing or invalid');
      return out;
    }
    for (const cat of Object.keys(catalogData)){
      const sub = catalogData[cat];
      for (const subcat of Object.keys(sub)){
        const items = sub[subcat];
        for (const it of items){
          if (ft && !it.name.toLowerCase().includes(ft) && !subcat.toLowerCase().includes(ft) && !cat.toLowerCase().includes(ft)) continue;
          const m = meta[it.id] || {};
          out.push({ category: cat, subcategory: subcat, favorite: !!m.favorite, last_bought: m.last_bought || null, ...it });
        }
      }
    }
    return out;
  }

  function renderCatalog(){
    let items = flattenCatalog(searchEl.value);
    if (favFilterEl.checked) items = items.filter(i => i.favorite);
    if (sortByEl.value === 'last_desc') items.sort((a,b) => (b.last_bought? new Date(b.last_bought).getTime() : 0) - (a.last_bought? new Date(a.last_bought).getTime() : 0));
    if (sortByEl.value === 'last_asc') items.sort((a,b) => (a.last_bought? new Date(a.last_bought).getTime() : 0) - (b.last_bought? new Date(b.last_bought).getTime() : 0));
    const rows = items.map(it => {
      const added = chosen.find(c => c.id === it.id);
      return `<div class=\"rounded-lg ring-1 ring-gray-200 bg-white/90 hover:shadow transition px-3 py-2\">\
        <div class=\"flex items-center justify-between\">\
          <div>\
            <div class=\"font-medium\">${it.name}</div>\
            <div class=\"text-xs muted\">${it.category} ‚Ä¢ ${it.subcategory} ‚Ä¢ ${it.source}${it.last_bought ? ' ‚Ä¢ last bought ' + new Date(it.last_bought).toLocaleDateString() : ''}</div>\
          </div>\
          <div class=\"flex items-center gap-2\">\
            <button class=\"${added?'btn-secondary':'btn'} text-sm px-3 py-1\" data-add=\"${it.id}\">${added? 'Added' : '+ Add'}<\/button>\
            <button class=\"btn-secondary text-sm px-2 py-1\" data-fav=\"${it.id}\">${it.favorite? '‚òÖ Fav' : '‚òÜ Fav'}<\/button>\
            <input type=\"date\" class=\"text-sm rounded border-gray-300\" value=\"${it.last_bought||''}\" data-date=\"${it.id}\">\
          </div>\
        </div>\
      <\/div>`;
    });
    catalogEl.innerHTML = rows.join('') || '<p class="muted">No matches.</p>';
    catalogEl.querySelectorAll('button[data-add]').forEach(b => b.addEventListener('click', () => {
      const id = b.getAttribute('data-add');
      const it = flattenCatalog().find(x => x.id === id);
      if (!it) return;
      if (!chosen.find(c => c.id === id)) chosen.push({ id: it.id, name: it.name, source: it.source });
      renderCatalog();
      renderMarkdown();
    }));
    catalogEl.querySelectorAll('button[data-fav]').forEach(b => b.addEventListener('click', async () => {
      const id = b.getAttribute('data-fav');
      const newVal = b.textContent.includes('‚òÜ');
      await fetch('/.netlify/functions/shopping-item-meta-upsert', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ item_key: id, favorite: newVal })});
      await loadMeta();
      renderCatalog();
    }));
    catalogEl.querySelectorAll('input[type=date][data-date]').forEach(inp => inp.addEventListener('change', async () => {
      const id = inp.getAttribute('data-date');
      const val = inp.value || null;
      await fetch('/.netlify/functions/shopping-item-meta-upsert', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ item_key: id, last_bought: val })});
      await loadMeta();
      renderCatalog();
    }));
  }

  function renderMarkdown(){
    const lines = chosen.map(c => `- [ ] ${c.name}${c.source ? ' ('+c.source+')' : ''}`);
    mdEl.textContent = lines.join('\n');
  }

  async function loadLists(){
    const r = await fetch('/.netlify/functions/shopping-lists');
    if (!r.ok) return;
    const lists = await r.json();
    listsEl.innerHTML = lists.map(l => `<div class="rounded-lg ring-1 ring-gray-200 bg-white/90 px-3 py-2 mb-2">\
      <a class="font-medium" href="/shopping/view/?id=${l.id}">${l.title}</a>\
      <span class="muted text-xs ml-2">${new Date(l.created_at).toLocaleString()}</span>\
      ${l.description ? `<div class="muted text-xs mt-1">${l.description}</div>` : ''}\
    </div>`).join('') || '<p class="muted">No lists yet.</p>';
  }

  saveBtn.addEventListener('click', async () => {
    if (chosen.length === 0) return alert('Choose some items');
  const res = await fetch('/.netlify/functions/shopping-list-create', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ title: titleEl.value || 'Shopping List', description: descEl.value || undefined, items: chosen, setLastBoughtOnSave: document.getElementById('setBought').checked }) });
    if (!res.ok) return alert('Save failed');
    const { id, share_token } = await res.json();
    viewLatest.href = `/shopping/view/?id=${id}`;
    viewLatest.textContent = 'Open Saved List';
    if (share_token) {
      shareLink.href = `/shopping/share/?t=${share_token}`;
      shareLink.classList.remove('hidden');
    }
    await loadLists();
  });

  copyBtn.addEventListener('click', async () => {
    await navigator.clipboard.writeText(mdEl.textContent);
    copyBtn.textContent = 'Copied';
    setTimeout(() => copyBtn.textContent = 'Copy Markdown', 1200);
  });

  searchEl.addEventListener('input', renderCatalog);
  // voice capture for shopping list (with Safari/MP4 fallback)
  const micBtn = document.getElementById('micBtn');
  const micStatus = document.getElementById('micStatus');
  let recording = false;
  let activeRecorder = null;
  let activeStream = null;
  let stopTimer = null;
  function pickMime(){
    const candidates = [
      'audio/webm;codecs=opus',
      'audio/webm',
      'audio/mp4;codecs=mp4a.40.2',
      'audio/mp4',
      'audio/ogg;codecs=opus',
      'audio/ogg'
    ];
    for (const t of candidates){
      if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
    }
    return '';
  }
  async function toggleMic(){
    try {
      if (!recording){
        micStatus.textContent = 'Recording‚Ä¶ click again to stop';
        micBtn.classList.add('!bg-orange-500','!text-black');
        micBtn.textContent = 'Click to stop recording';
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        activeStream = stream;
        const chunks = [];
        const mimeType = pickMime();
        const rec = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
        activeRecorder = rec;
        rec.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };
        const done = new Promise(resolve => { rec.onstop = () => resolve(new Blob(chunks, { type: mimeType || 'audio/webm' })); });
        rec.start();
        recording = true;
        micBtn.classList.add('opacity-70');
        // auto stop after 30s
        stopTimer = setTimeout(()=>{ if (recording) rec.stop(); }, 30000);
        const audio = await done;
        // cleanup
        clearTimeout(stopTimer); stopTimer = null;
  activeStream.getTracks().forEach(t=>t.stop());
  activeStream = null; activeRecorder = null; recording = false; micBtn.classList.remove('opacity-70','!bg-orange-500','!text-black');
  micBtn.textContent = 'üéôÔ∏è Speak items';
        micStatus.textContent = 'Transcribing‚Ä¶';
        const filename = (mimeType && mimeType.includes('mp4')) ? 'speech.m4a' : (mimeType && mimeType.includes('ogg') ? 'speech.ogg' : 'speech.webm');
  const res = await fetch('/.netlify/functions/whisper-transcribe', { method: 'POST', headers: { 'content-type': audio.type || mimeType || 'audio/webm', 'x-filename': filename, 'x-base64': '0' }, body: audio });
        if (res.status === 401) { micStatus.textContent = 'Please sign in'; return; }
  if (!res.ok) { micStatus.textContent = 'Transcribe failed: ' + (await res.text()).slice(0,180); return; }
        const { text } = await res.json();
        micStatus.textContent = 'Parsed';
        const parts = text.split(/[\n,]/).map(s => s.trim()).filter(Boolean);
        const flat = flattenCatalog();
        for (const p of parts){
          const match = flat.find(it => it.name.toLowerCase() === p.toLowerCase() || it.name.toLowerCase().includes(p.toLowerCase()));
          if (match && !chosen.find(c => c.id === match.id)) chosen.push({ id: match.id, name: match.name, source: match.source });
        }
        renderCatalog(); renderMarkdown();
        micStatus.textContent = parts.length ? `Added ${parts.length} items` : 'No matches';
      } else {
        // stop
  if (activeRecorder) activeRecorder.stop();
  micBtn.classList.remove('!bg-orange-500','!text-black');
  micBtn.textContent = 'üéôÔ∏è Speak items';
      }
    } catch(e){
      console.error(e);
      try { if (activeStream) activeStream.getTracks().forEach(t=>t.stop()); } catch {}
      recording = false; activeRecorder = null; activeStream = null; if (stopTimer) clearTimeout(stopTimer);
      micBtn.classList.remove('opacity-70');
      micStatus.textContent = 'Mic error';
    }
  }
  micBtn.addEventListener('click', toggleMic);
  favFilterEl.addEventListener('change', renderCatalog);
  sortByEl.addEventListener('change', renderCatalog);
  addAllBtn.addEventListener('click', () => {
    let items = flattenCatalog(searchEl.value);
    if (favFilterEl.checked) items = items.filter(i => i.favorite);
    const ids = new Set(chosen.map(c => c.id));
    items.forEach(it => { if (!ids.has(it.id)) chosen.push({ id: it.id, name: it.name, source: it.source }); });
    renderCatalog();
    renderMarkdown();
  });
  resetFavsBtn.addEventListener('click', async () => { await fetch('/.netlify/functions/shopping-item-meta-reset?scope=favorites', { method:'POST' }); await loadMeta(); renderCatalog(); });
  resetDatesBtn.addEventListener('click', async () => { await fetch('/.netlify/functions/shopping-item-meta-reset?scope=dates', { method:'POST' }); await loadMeta(); renderCatalog(); });

  async function loadMeta(){
    const r = await fetch('/.netlify/functions/shopping-item-meta-list');
    if (!r.ok) { meta = {}; return; }
    const arr = await r.json();
    meta = Object.fromEntries(arr.map(x => [x.item_key, { favorite: x.favorite, last_bought: x.last_bought }]));
  }
  await loadMeta();
  renderCatalog();
  renderMarkdown();
  loadLists();
})();
</script>
